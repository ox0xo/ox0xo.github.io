---
layout: post
title:  "FireEye TechLounge 6 Writeup"
date:   2019-03-28
permalink: /security/:title
categories: CTF
tags: CTF
excerpt: FireEye主催のSecurity Tech Lunge Vol.6 春のCTFセンバツのWriteupです。
---

* content
{:toc}

# Q1. packet

ICMPのパケットが与えられる。

![](/images/FE6/1_1.png)

全体を眺めていくとLengthが3種類あることが分かる。
- 先頭と末尾に98が多い
- 中程には153と99が多いが98も少し含まれている

何となく3種類のパケットの配置に規則性が見えてきた。
リクエストパケットだけに絞って観察するとさらに分かりやすい。
99と153が7つ続いた後に98が1つ出現している。
7つの値で表現できる情報といえば[ASCIIコード](https://ja.wikipedia.org/wiki/ASCII)だ。

![](/images/FE6/1_2.png)

98をデリミタとして99=0、153=1に置き換えるスクリプトを書く。

<script src="https://gist.github.com/ox0xo/627fa247b11deea0bf083e5068615dc2.js"></script>

答えは `FLAG_ping2c`
(ping to char？)

# Q2. ctf

出題意図とかけ離れたところで苦しんだ問題。
ELFが与えられるが実行できない。
TrusugiやKaliはベースのOSが古くてglibcのバージョンを上げられないことが原因だった。
Ubuntu18.10に環境を移すことで解決した。

- 動かない環境の例

```
root@user-VirtualBox:/tmp# ./ctf
./ctf: /lib/x86_64-linux-gnu/libm.so.6: version `GLIBC_2.27' not found (required by ./ctf)

root@user-VirtualBox:/tmp# apt list libc6 -a
Listing... Done
libc6/xenial-updates,now 2.23-0ubuntu11 amd64 [installed]
libc6/xenial-security 2.23-0ubuntu10 amd64
libc6/xenial 2.23-0ubuntu3 amd64

root@user-VirtualBox:/tmp# head -2 /etc/os-release
NAME="Ubuntu"
VERSION="16.04.6 LTS (Xenial Xerus)"
```

- これなら動く

```
root@user-VirtualBox:~# apt list libc6 -a
一覧表示... 完了
libc6/cosmic,now 2.28-0ubuntu1 amd64 [インストール済み、自動]
libc6/cosmic 2.28-0ubuntu1 i386

root@user-VirtualBox:~# head -2 /etc/os-release
NAME="Ubuntu"
VERSION="18.10 (Cosmic Cuttlefish)"
```

ということで動かしてみると何か送っているらしいメッセージが出力される。

```
root@user-VirtualBox:/tmp# ./ctf
Sending data...
```

enp0s3のパケットを取ってみるが何も見当たらないので処理の中身を覗いてみる。
`127.0.0.1`が見えるのでloを見張らないとダメだったみたい。

```
[----------------------------------registers-----------------------------------]
RAX: 0x30 ('0')
RBX: 0x7fffffff9b00 --> 0x0
RCX: 0x7fffffff9ab0 --> 0x7ffff4a96130 (<_nss_files_getservbyname_r>:   push   r15)
RDX: 0x11
RSI: 0x7fffffff9ad0 --> 0x0
RDI: 0x4200106830 ("127.0.0.1")
RBP: 0x7fffffff9d20 --> 0x7fffffffa270 --> 0x4200006220 --> 0x4c0428 (movsxd rax,ebx)
RSP: 0x7fffffff9ad0 --> 0x0
RIP: 0x7ffff7a897aa (<gaih_inet+474>:   test   BYTE PTR [r15],0x40)
R8 : 0x3
R9 : 0x0
R10: 0x7ffff7b1eae0 --> 0x100000000
R11: 0x206
R12: 0x7ffff7b32692 --> 0x706475 (clc)
R13: 0x7fffffff9e20 --> 0x7fffffff9e30 --> 0x9006e69616d6f64 ('domain')
R14: 0x7ffff7b32688 --> 0x1100000002
R15: 0x42001068b0 --> 0x25 ('%')
EFLAGS: 0x206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x7ffff7a89795 <gaih_inet+453>:      mov    DWORD PTR [rsi+0x10],0x0
   0x7ffff7a8979c <gaih_inet+460>:      mov    DWORD PTR [rsi+0x24],0x0
   0x7ffff7a897a3 <gaih_inet+467>:      mov    QWORD PTR [rsi],0x0
=> 0x7ffff7a897aa <gaih_inet+474>:      test   BYTE PTR [r15],0x40
```

パケットの中身はDNSクエリだった。
エンコードしたデータを分割送信しているっぽい。

![](/images/FE6/2_1.png)

結合したデータをデコードする。

<script src="https://gist.github.com/ox0xo/5802b110212a994e3e75ed9be5ad38fc.js"></script>

最初はBase64かと思ったけどちゃんと読めないし、よく見ると使われている文字数が少なすぎる。
アルファベットと数字しか見えないので26+10で30前後？
Base32を試したらPNGが入手できた。

![](/images/FE6/2_2.png)

答えは `FLAG_DNS4Everything`


# Q3.
頑張ってます

# Q4.
頑張ってます
